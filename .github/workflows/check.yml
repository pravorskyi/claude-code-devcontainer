name: Check for Updates

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.devcontainer.outputs.has_changes }}
      devcontainer_sha: ${{ steps.devcontainer.outputs.devcontainer_sha }}
      needs_rebuild: ${{ steps.claude.outputs.needs_rebuild }}
      claude_version: ${{ steps.claude.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for .devcontainer updates
        id: devcontainer
        run: |
          NEW_COMMIT=$(curl -sf "https://api.github.com/repos/anthropics/claude-code/commits?path=.devcontainer&per_page=1" | jq -r '.[0].sha')
          OLD_COMMIT=$(git rev-parse HEAD:claude-code)

          echo "Upstream: $NEW_COMMIT"
          echo "Current:  $OLD_COMMIT"

          if [ -z "$NEW_COMMIT" ] || [ "$NEW_COMMIT" = "null" ]; then
            echo "::error::Failed to fetch upstream commit"
            exit 1
          fi

          if [ "$NEW_COMMIT" = "$OLD_COMMIT" ]; then
            echo "No .devcontainer changes"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo ".devcontainer changes detected"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "devcontainer_sha=$NEW_COMMIT" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new Claude Code release
        id: claude
        run: |
          LATEST=$(curl -sf https://registry.npmjs.org/@anthropic-ai/claude-code/latest | jq -r '.version')
          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "::error::Failed to fetch latest claude-code version from npm"
            exit 1
          fi
          echo "Latest npm version: $LATEST"
          echo "version=$LATEST" >> "$GITHUB_OUTPUT"

          IMAGE="ghcr.io/${{ github.repository }}/devcontainer"
          if docker manifest inspect "$IMAGE:claude-code-$LATEST" > /dev/null 2>&1; then
            echo "Image exists for claude-code $LATEST"
            echo "needs_rebuild=false" >> "$GITHUB_OUTPUT"
          else
            echo "No image for claude-code $LATEST - rebuild needed"
            echo "needs_rebuild=true" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: check
    if: needs.check.outputs.has_changes == 'true' || needs.check.outputs.needs_rebuild == 'true'
    uses: ./.github/workflows/devcontainer.yml
    with:
      claude_code_version: ${{ needs.check.outputs.claude_version }}

  update-submodule:
    needs: [check, build]
    if: needs.check.outputs.has_changes == 'true'
    uses: ./.github/workflows/update-submodule.yml
    with:
      devcontainer_sha: ${{ needs.check.outputs.devcontainer_sha }}
